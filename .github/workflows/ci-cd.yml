name: MLOps CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      S3_BUCKET: ${{ secrets.S3_BUCKET }}
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY_URI }}

    steps:
    # Checkout repo
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # Cache pip dependencies
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    # Setup Python
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # Install DVC and Docker dependencies for workflow
    - name: Install workflow dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install --no-cache-dir --prefer-binary \
          "dvc[s3]==3.51.0" \
          "docker==6.1.3" \
          "boto3==1.34.69"

    # Configure AWS credentials
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    # Login to Amazon ECR using official action (before Buildx)
    - name: Login to Amazon ECR
      if: env.ECR_REPOSITORY != ''
      uses: aws-actions/amazon-ecr-login@v2
      id: ecr-login

    # Log in to Docker Hub
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        registry: docker.io

    # Set up Docker Buildx (after logins so it picks up credentials)
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # Pull model from S3 using DVC (REQUIRED)
    - name: Pull model from S3 via DVC
      run: |
        echo "Pulling model from S3..."
        echo "DVC remote config:"
        dvc remote list
        
        # Pull model (DVC handles chunked files automatically)
        dvc pull -v
        
        # Verify model file exists and has correct size
        if [ -f plant_disease_model.h5 ]; then
          MODEL_SIZE=$(stat -f%z plant_disease_model.h5 2>/dev/null || stat -c%s plant_disease_model.h5 2>/dev/null)
          echo "âœ… Model pulled successfully"
          echo "   Size: $MODEL_SIZE bytes (~$(($MODEL_SIZE / 1024 / 1024))MB)"
          ls -lh plant_disease_model.h5
        else
          echo "âŒ Model file not found after pull"
          echo "Checking DVC cache:"
          dvc status
          exit 1
        fi

    # Build and push Docker image to Docker Hub and ECR
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/plant-disease-detector:latest
          ${{ secrets.DOCKER_USERNAME }}/plant-disease-detector:${{ github.sha }}
          ${{ env.ECR_REPOSITORY }}:latest
          ${{ env.ECR_REPOSITORY }}:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64
      env:
        DOCKER_CONFIG: ${{ steps.ecr-login.outputs.docker-config }}

  # Deploy to EC2 after successful build and push
  deploy-to-ec2:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY_URI }}
      EC2_HOST: ${{ secrets.EC2_HOST }}
      EC2_USER: ${{ secrets.EC2_USER }}
      EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "$EC2_SSH_KEY" > ~/.ssh/ec2_key.pem
        chmod 600 ~/.ssh/ec2_key.pem
        ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts

    - name: Deploy to EC2
      if: env.EC2_HOST != '' && env.EC2_USER != '' && env.EC2_SSH_KEY != ''
      run: |
        ssh -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST << 'EOF'
          set -e
          
          echo "ğŸš€ Starting deployment to EC2..."
          
          # Install Docker if not installed
          if ! command -v docker &> /dev/null; then
            echo "ğŸ“¦ Installing Docker..."
            sudo yum update -y
            sudo yum install docker -y
            sudo systemctl start docker
            sudo systemctl enable docker
            sudo usermod -a -G docker $USER
          fi
          
          # Install AWS CLI if not installed
          if ! command -v aws &> /dev/null; then
            echo "ğŸ“¦ Installing AWS CLI..."
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip -q awscliv2.zip
            sudo ./aws/install
            rm -rf aws awscliv2.zip
          fi
          
          # Login to ECR (works with IAM role or configured credentials)
          echo "ğŸ” Logging in to ECR..."
          if ! aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | \
            docker login --username AWS --password-stdin ${{ secrets.ECR_REPOSITORY_URI }}; then
            echo "âŒ Failed to login to ECR. Check AWS credentials or IAM role."
            exit 1
          fi
          
          # Stop and remove old container if it exists
          if docker ps -a --format '{{.Names}}' | grep -q "^plant-disease-app$"; then
            echo "ğŸ›‘ Stopping old container..."
            docker stop plant-disease-app || true
            docker rm plant-disease-app || true
          fi
          
          # Pull latest image
          echo "ğŸ“¥ Pulling latest image from ECR..."
          docker pull ${{ secrets.ECR_REPOSITORY_URI }}:latest
          
          # Run new container
          echo "ğŸš€ Starting new container..."
          docker run -d \
            --name plant-disease-app \
            -p 8501:8501 \
            --restart unless-stopped \
            ${{ secrets.ECR_REPOSITORY_URI }}:latest
          
          # Wait a moment for container to start
          sleep 5
          
          # Verify container is running
          if docker ps --format '{{.Names}}' | grep -q "^plant-disease-app$"; then
            echo "âœ… Deployment successful! Container is running."
            echo "ğŸ“Š Container status:"
            docker ps --filter name=plant-disease-app
            echo ""
            echo "ğŸŒ Access your app at: http://$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4):8501"
          else
            echo "âŒ Container failed to start. Checking logs:"
            docker logs plant-disease-app
            exit 1
          fi
        EOF

    - name: Deployment Summary
      run: |
        echo "âœ… Deployment to EC2 completed successfully!"
        echo "ğŸŒ Access your app at: http://${{ secrets.EC2_HOST }}:8501"
