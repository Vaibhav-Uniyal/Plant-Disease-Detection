name: MLOps CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      S3_BUCKET: ${{ secrets.S3_BUCKET }}
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

    steps:
    # Checkout repo
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # Cache pip dependencies
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    # Setup Python
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # Install DVC and Docker dependencies for workflow
    - name: Install workflow dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install --no-cache-dir --prefer-binary \
          "dvc[s3]==3.51.0" \
          "docker==6.1.3" \
          "boto3==1.34.69"

    # Configure AWS credentials
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    # Log in to Docker Hub
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        registry: docker.io

    # Note: We're NOT using Buildx to avoid credential scope issues
    # Standard Docker will be used for all operations

    # Pull model from S3 using DVC (REQUIRED)
    - name: Pull model from S3 via DVC
      run: |
        echo "Pulling model from S3..."
        echo "DVC remote config:"
        dvc remote list
        
        # Pull model (DVC handles chunked files automatically)
        dvc pull -v
        
        # Verify model file exists and has correct size
        if [ -f plant_disease_model.h5 ]; then
          MODEL_SIZE=$(stat -f%z plant_disease_model.h5 2>/dev/null || stat -c%s plant_disease_model.h5 2>/dev/null)
          echo "‚úÖ Model pulled successfully"
          echo "   Size: $MODEL_SIZE bytes (~$(($MODEL_SIZE / 1024 / 1024))MB)"
          ls -lh plant_disease_model.h5
        else
          echo "‚ùå Model file not found after pull"
          echo "Checking DVC cache:"
          dvc status
          exit 1
        fi

    # Build Docker image using standard Docker (not Buildx to avoid credential scope issues)
    - name: Build Docker image
      run: |
        echo "üî® Building Docker image..."
        docker build -t plant-disease-detector:latest .
        echo "‚úÖ Image built successfully"

    # Tag and push to Docker Hub
    - name: Tag and push to Docker Hub
      run: |
        echo "üì§ Tagging for Docker Hub..."
        docker tag plant-disease-detector:latest ${{ secrets.DOCKER_USERNAME }}/plant-disease-detector:latest
        docker tag plant-disease-detector:latest ${{ secrets.DOCKER_USERNAME }}/plant-disease-detector:${{ github.sha }}
        
        echo "üöÄ Pushing to Docker Hub..."
        docker push ${{ secrets.DOCKER_USERNAME }}/plant-disease-detector:latest
        docker push ${{ secrets.DOCKER_USERNAME }}/plant-disease-detector:${{ github.sha }}
        echo "‚úÖ Docker Hub push complete!"

  # Deploy to EC2 after successful build and push
  deploy-to-ec2:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    env:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      EC2_HOST: ${{ secrets.EC2_HOST }}
      EC2_USER: ${{ secrets.EC2_USER }}
      EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
    
    steps:
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "$EC2_SSH_KEY" > ~/.ssh/ec2_key.pem
        chmod 600 ~/.ssh/ec2_key.pem
        ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts

    - name: Deploy to EC2
      if: env.EC2_HOST != '' && env.EC2_USER != '' && env.EC2_SSH_KEY != ''
      run: |
        ssh -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST << EOF
          set -e
          
          DOCKER_USERNAME="${{ secrets.DOCKER_USERNAME }}"
          DOCKER_PASSWORD="${{ secrets.DOCKER_PASSWORD }}"
          DOCKER_IMAGE="${{ secrets.DOCKER_USERNAME }}/plant-disease-detector:latest"
          
          echo "üöÄ Starting deployment to EC2..."
          
          # Install Docker if not installed
          if ! command -v docker &> /dev/null; then
            echo "üì¶ Installing Docker..."
            sudo yum update -y
            sudo yum install docker -y
            sudo systemctl start docker
            sudo systemctl enable docker
            # Add current user to docker group (works for ec2-user or any user)
            CURRENT_USER=\$(whoami)
            sudo usermod -a -G docker "\$CURRENT_USER"
            echo "‚úÖ Added user \$CURRENT_USER to docker group"
            echo "‚ÑπÔ∏è  Note: You may need to log out and back in for group changes to take effect"
            echo "‚ÑπÔ∏è  For now, using sudo for docker commands"
          fi
          
          # Use sudo for docker commands if user is not in docker group yet
          DOCKER_CMD="docker"
          if ! groups | grep -q docker; then
            DOCKER_CMD="sudo docker"
            echo "‚ö†Ô∏è  Using sudo for docker commands (group membership takes effect after logout)"
          fi
          
          # Login to Docker Hub (if credentials provided, for private repos)
          if [ -n "\$DOCKER_PASSWORD" ]; then
            echo "üîê Logging in to Docker Hub..."
            echo "\$DOCKER_PASSWORD" | \$DOCKER_CMD login --username "\$DOCKER_USERNAME" --password-stdin
          fi
          
          # Stop and remove old container if it exists
          if \$DOCKER_CMD ps -a --format '{{.Names}}' | grep -q "^plant-disease-app$"; then
            echo "üõë Stopping old container..."
            \$DOCKER_CMD stop plant-disease-app || true
            \$DOCKER_CMD rm plant-disease-app || true
          fi
          
          # Pull latest image from Docker Hub
          echo "üì• Pulling latest image from Docker Hub..."
          \$DOCKER_CMD pull "\$DOCKER_IMAGE"
          
          # Run new container
          echo "üöÄ Starting new container..."
          \$DOCKER_CMD run -d \
            --name plant-disease-app \
            -p 8501:8501 \
            --restart unless-stopped \
            "\$DOCKER_IMAGE"
          
          # Wait a moment for container to start
          sleep 5
          
          # Verify container is running
          if \$DOCKER_CMD ps --format '{{.Names}}' | grep -q "^plant-disease-app$"; then
            echo "‚úÖ Deployment successful! Container is running."
            echo "üìä Container status:"
            \$DOCKER_CMD ps --filter name=plant-disease-app
            echo ""
            echo "üåê Access your app at: http://$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4):8501"
          else
            echo "‚ùå Container failed to start. Checking logs:"
            \$DOCKER_CMD logs plant-disease-app
            exit 1
          fi
        EOF

    - name: Deployment Summary
      run: |
        echo "‚úÖ Deployment to EC2 completed successfully!"
        echo "üåê Access your app at: http://${{ secrets.EC2_HOST }}:8501"
